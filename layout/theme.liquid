<!doctype html>
<html lang="{{ request.locale.iso_code }}">
  <head>
    {% # Inlined CSS Variables %}
    {% render 'css-variables' %}

    {% # Load and preload the critical CSS %}
    {{ 'critical.css' | asset_url | stylesheet_tag: preload: true }}

    {% # Social, title, etc. %}
    {% render 'meta-tags' %}

    {%- comment -%} Google Fonts: Exo 2 {%- endcomment -%}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,300;0,400;0,600;0,700;1,400&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    {%- comment -%} Gobold font {%- endcomment -%}
    <style>
      @font-face {
        font-family: 'Gobold';
        src: url('{{ "Gobold-Regular.otf" | asset_url }}') format('opentype');
        font-weight: 400;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: 'Gobold';
        src: url('{{ "Gobold-Bold.otf" | asset_url }}') format('opentype');
        font-weight: 500;
        font-style: normal;
        font-display: swap;
      }
      :root { 
        --font-primary--family: 'Exo 2', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        --font-secondary--family: 'Gobold', sans-serif;
      }
      .site-preloader {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(251, 251, 251, 1);
        backdrop-filter: blur(6px);
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 1 ease, visibility 0s linear 0.55s;
      }
      .site-preloader--active {
        opacity: 1;
        visibility: visible;
        transition: opacity 0.55s ease;
      }
      .site-preloader--hidden {
        opacity: 0;
        pointer-events: none;
        visibility: hidden;
        transition: opacity 0.45s ease, visibility 0s linear 0.45s;
      }
      .site-preloader__media {
        width: clamp(160px, 25vw, 320px);
        max-width: 360px;
        height: auto;
        display: block;
        transform: scale(1.4);
        transform-origin: center;
      }
      body.site-preloader-active {
        overflow: hidden;
        height: 100vh;
      }
    </style>

    {{ content_for_header }}
  </head>

  <body{% unless template.name == 'index' or template == 'index' %} class="has-sticky-header"{% endunless %}>
    {% if template.name == 'index' or template == 'index' %}
      <div id="site-preloader" class="site-preloader" aria-live="polite" aria-label="{{ 'general.loading' | t | default: 'Loading' }}">
        <video class="site-preloader__media" src="{{ 'preloader.webm' | asset_url }}" autoplay muted playsinline preload="auto"></video>
      </div>
    {% endif %}
    {% sections 'header-group' %}

    <main class="page-content">
      {{ content_for_layout }}
    </main>

    {% sections 'footer-group' %}

    {%- comment -%} Pre-initialize cart on first page load to avoid cold start delay {%- endcomment -%}
    <script>
      (function() {
        var preloader = document.getElementById('site-preloader');
        if (preloader) {
          var body = document.body;
          var media = preloader.querySelector('.site-preloader__media');
          var isHardNavigation = true;

          if (window.performance && typeof window.performance.getEntriesByType === 'function') {
            var navEntries = window.performance.getEntriesByType('navigation');
            if (navEntries && navEntries[0]) {
              isHardNavigation = navEntries[0].type === 'navigate' || navEntries[0].type === 'reload';
            }
          }

          var hidePreloader = function(forceImmediate) {
            if (!preloader || preloader.classList.contains('site-preloader--hidden')) return;
            preloader.classList.remove('site-preloader--active');
            preloader.classList.add('site-preloader--hidden');
            body.classList.remove('site-preloader-active');
            window.setTimeout(function() {
              if (preloader && preloader.parentNode) {
                preloader.parentNode.removeChild(preloader);
                preloader = null;
              }
            }, forceImmediate ? 0 : 550);
          };

          if (!isHardNavigation) {
            hidePreloader(true);
          } else {
            body.classList.add('site-preloader-active');
            window.requestAnimationFrame(function() {
              window.requestAnimationFrame(function() {
                if (preloader) {
                  preloader.classList.add('site-preloader--active');
                }
              });
            });

            if (media) {
              media.playbackRate = 2;
              media.addEventListener('ended', hidePreloader);
              media.addEventListener('error', hidePreloader);
              media.play().catch(function() {
                hidePreloader();
              });
            }

            window.setTimeout(hidePreloader, 12000);
          }

          window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
              hidePreloader(true);
            }
          });
        }

        // Only initialize once per session to avoid unnecessary requests
        if (sessionStorage.getItem('cartInitialized') === 'true') return;
        
        // Mark as initialized immediately to prevent duplicate requests
        sessionStorage.setItem('cartInitialized', 'true');
        
        // Make a lightweight request to initialize the cart session
        // This runs in the background and doesn't block page rendering
        fetch('/cart.js', {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          credentials: 'same-origin'
        }).catch(function() {
          // Silently fail - this is just a warm-up request
          // If it fails, the cart will still initialize on first add-to-cart
        });
      })();
    </script>
  </body>
</html>
