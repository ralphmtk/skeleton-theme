{% comment %}
  Renders a product card for the range page.
  
  Accepts:
  - product: {Object} Product Liquid object
  - is_unavailable: {Boolean} Whether the product is unavailable in the user's country
  - user_country_code: {String} The user's country code (optional, mostly for debugging)
  - localization: {Object} Localization object for country name
  - collection_handle: {String} The handle of the collection this product belongs to
{% endcomment %}

{%- assign custom_style = product.metafields.custom.custom_style | strip | downcase -%}

{%- comment -%} Only lighter collections use cap/body/flame animations. Everything else uses simple image swap. {%- endcomment -%}
{%- assign use_simple_image = true -%}
{%- if collection_handle contains 'lighter' -%}
  {%- assign use_simple_image = false -%}
{%- endif -%}

{%- comment -%} Override: ZL5 Slider uses simple image swap even though it's a lighter {%- endcomment -%}
{%- if custom_style == 'zl5' or product.handle contains 'zl-5' or product.handle contains 'zl5' -%}
  {%- assign use_simple_image = true -%}
{%- endif -%}

<a class="prod-card{% if is_unavailable %} prod-card--unavailable{% endif %}{% if use_simple_image %} prod-card--simple{% endif %}{% if custom_style != blank and use_simple_image == false %} prod-card--custom prod-card--style-{{ custom_style }}{% endif %}" href="{{ product.url }}"{% if custom_style != blank and use_simple_image == false %} data-custom-style="{{ custom_style }}"{% endif %}>
  {%- if use_simple_image -%}
    {%- comment -%} Simple image swap for non-lighter collections {%- endcomment -%}
    <div class="prod-card__image-wrapper prod-card__image-wrapper--simple">
      {% if is_unavailable %}
        <div class="prod-card__unavailable-label">Not available in {{ localization.country.name }}</div>
      {% endif %}
      {%- if product.featured_image -%}
        {% render 'image', class: 'prod-card__image prod-card__image--primary', image: product.featured_image, width: 600, height: 600, crop: 'center' %}
      {%- endif -%}
      {%- if product.images[1] -%}
        {% render 'image', class: 'prod-card__image prod-card__image--secondary', image: product.images[1], width: 600, height: 600, crop: 'center' %}
      {%- endif -%}
    </div>
  {%- elsif custom_style != blank -%}
    {%- comment -%} Custom style: blank state with offset metafields support {%- endcomment -%}
    {% if product.metafields.custom.animation_body and product.metafields.custom.animation_cap %}
      {%- assign cap_y_offset = product.metafields.custom.animation_cap_y_offset | default: '65.5' -%}
      {%- assign cap_x_offset = product.metafields.custom.animation_cap_x_offset | default: '0' -%}
      {%- assign flame_y_offset = product.metafields.custom.animation_flame_y_offset | default: '100' -%}
      {%- assign flame_x_offset = product.metafields.custom.animation_flame_x_offset | default: '0' -%}
      {%- assign body_x_offset = product.metafields.custom.animation_body_x_offset | default: '0' -%}
      {%- assign body_y_offset = product.metafields.custom.animation_body_y_offset | default: '0' -%}
      {%- assign flame_count = product.metafields.custom.number_of_flames | default: 1 -%}
      {%- assign flame_count_value = flame_count | plus: 0 -%}
      {%- if custom_style == 'zl17' -%}
        {%- assign flame_asset = 'zl17_flame.png' -%}
      {%- elsif custom_style == 'zl19' -%}
        {%- assign flame_asset = 'zl19_flame.png' -%}
      {%- else -%}
        {%- assign flame_asset = 'flame.png' -%}
        {%- if flame_count != blank and flame_count_value >= 2 -%}
          {%- assign flame_asset = 'double_flame.png' -%}
        {%- endif -%}
      {%- endif -%}
      <div class="prod-card__image-wrapper prod-card__image-wrapper--parts">
        {% if is_unavailable %}
          <div class="prod-card__unavailable-label">Not available in {{ localization.country.name }}</div>
        {% endif %}
        <div class="prod-card__parts-container">
          <img class="prod-card__body" src="{{ product.metafields.custom.animation_body | file_url }}" alt="{{ product.title }}" width="600" height="600" loading="lazy" style="transform: translate({{ body_x_offset }}px, {{ body_y_offset }}px);">
          <img class="prod-card__cap" src="{{ product.metafields.custom.animation_cap | file_url }}" alt="" width="600" height="600" loading="lazy" style="bottom: {{ cap_y_offset }}%; left: calc(50% + {{ cap_x_offset }}px);">
          <img class="prod-card__flame" src="{{ flame_asset | asset_url }}" alt="" width="600" height="600" loading="lazy" style="bottom: calc(50% + {{ flame_y_offset }}px); left: calc(48.5% + {{ flame_x_offset }}px);">
        </div>
      </div>
    {% elsif product.featured_image %}
      <div class="prod-card__image-wrapper">
        {% if is_unavailable %}
          <div class="prod-card__unavailable-label">Not available in {{ localization.country.name }}</div>
        {% endif %}
        {% render 'image', class: 'prod-card__image', image: product.featured_image, width: 600, height: 600, crop: 'center' %}
      </div>
    {% endif %}
  {%- else -%}
    {%- comment -%} Default animations and styling for lighters {%- endcomment -%}
    {% if product.metafields.custom.animation_body and product.metafields.custom.animation_cap %}
      {%- assign cap_y_offset = product.metafields.custom.animation_cap_y_offset | default: '65.5' -%}
      {%- assign cap_x_offset = product.metafields.custom.animation_cap_x_offset | default: '0' -%}
      {%- assign flame_y_offset = product.metafields.custom.animation_flame_y_offset | default: '100' -%}
      {%- assign flame_x_offset = product.metafields.custom.animation_flame_x_offset | default: '0' -%}
      {%- assign body_x_offset = product.metafields.custom.animation_body_x_offset | default: '0' -%}
      {%- assign body_y_offset = product.metafields.custom.animation_body_y_offset | default: '0' -%}
      {%- assign flame_count = product.metafields.custom.number_of_flames | default: 1 -%}
      {%- assign flame_count_value = flame_count | plus: 0 -%}
      {%- if custom_style == 'zl17' -%}
        {%- assign flame_asset = 'zl17_flame.png' -%}
      {%- elsif custom_style == 'zl19' -%}
        {%- assign flame_asset = 'zl19_flame.png' -%}
      {%- else -%}
        {%- assign flame_asset = 'flame.png' -%}
        {%- if flame_count != blank and flame_count_value >= 2 -%}
          {%- assign flame_asset = 'double_flame.png' -%}
        {%- endif -%}
      {%- endif -%}
      <div class="prod-card__image-wrapper prod-card__image-wrapper--parts">
        {% if is_unavailable %}
          <div class="prod-card__unavailable-label">Not available in {{ localization.country.name }}</div>
        {% endif %}
        <div class="prod-card__parts-container">
          <img class="prod-card__body" src="{{ product.metafields.custom.animation_body | file_url }}" alt="{{ product.title }}" width="600" height="600" loading="lazy" style="transform: translate({{ body_x_offset }}px, {{ body_y_offset }}px);">
          <img class="prod-card__cap" src="{{ product.metafields.custom.animation_cap | file_url }}" alt="" width="600" height="600" loading="lazy" style="bottom: {{ cap_y_offset }}%; left: calc(50% + {{ cap_x_offset }}px);">
          <img class="prod-card__flame" src="{{ flame_asset | asset_url }}" alt="" width="600" height="600" loading="lazy" style="bottom: calc(50% + {{ flame_y_offset }}px); left: calc(48.5% + {{ flame_x_offset }}px);">
        </div>
      </div>
    {% elsif product.featured_image %}
      <div class="prod-card__image-wrapper">
        {% if is_unavailable %}
          <div class="prod-card__unavailable-label">Not available in {{ localization.country.name }}</div>
        {% endif %}
        {% render 'image', class: 'prod-card__image', image: product.featured_image, width: 600, height: 600, crop: 'center' %}
      </div>
    {% endif %}
  {%- endif -%}
  <div class="prod-card__info">
    <div class="prod-card__name">{{ product.title }}</div>
  </div>
</a>

