{% comment %}
  Shop page
{% endcomment %}

{%- comment -%} Count categories with products {%- endcomment -%}
{% assign category_count = 0 %}
{% for block in section.blocks %}
  {% if block.type == 'category' and block.settings.collection != blank %}
    {% assign col = block.settings.collection %}
    {% assign has_products = false %}
    {% for product in col.products limit: 1 %}
      {% assign has_products = true %}
    {% endfor %}
    {% if has_products %}
      {% assign category_count = category_count | plus: 1 %}
    {% endif %}
  {% endif %}
{% endfor %}

{% assign show_header = false %}
{% if category_count > 1 %}
  {% assign show_header = true %}
{% endif %}

<section class="shop full-width">
  {% if show_header %}
  <div class="shop__header">
    <div class="shop__header-inner">
      <h1 class="shop__title">SHOP</h1>
      
      {%- comment -%} Category jump-to buttons {%- endcomment -%}
      <div class="shop__category-filters">
      {% assign first = true %}
      {% for block in section.blocks %}
        {% if block.type == 'category' and block.settings.collection != blank %}
          {% assign col = block.settings.collection %}
          {% assign has_products = false %}
          {% for product in col.products limit: 1 %}
            {% assign has_products = true %}
          {% endfor %}
          {% if has_products %}
            {% assign mobile_title = col.title %}
            {% if mobile_title == 'Jet Lighters' %}{% assign mobile_title = 'Lighters' %}{% endif %}
            {% if mobile_title == 'Jet Torches' %}{% assign mobile_title = 'Torches' %}{% endif %}
            {% if mobile_title == 'Gas Refills' %}{% assign mobile_title = 'Gas' %}{% endif %}
            <button class="shop__category-filter{% if first %} is-active{% endif %}" data-target="{{ col.handle }}" type="button">
              {% if block.settings.category_icon != blank %}
                <img class="shop__category-icon" src="{{ block.settings.category_icon | image_url: width: 32 }}" alt="" width="16" height="16" loading="lazy">
              {% else %}
                <img class="shop__category-icon" src="{{ 'flame-icon.png' | asset_url }}" alt="" width="16" height="16" loading="lazy">
              {% endif %}
              <span class="shop__category-text">{{ col.title }}</span>
              <span class="shop__category-text--mobile">{{ mobile_title }}</span>
            </button>
            {% assign first = false %}
          {% endif %}
        {% endif %}
      {% endfor %}
      </div>
    </div>
  </div>
  
  {%- comment -%} Spacer to prevent content from going under fixed header {%- endcomment -%}
  <div class="shop__header-spacer"></div>
  {% endif %}

  <div class="shop__content">
    {% for block in section.blocks %}
      {% if block.type == 'category' and block.settings.collection != blank %}
        {% assign col = block.settings.collection %}
        {% assign has_products = false %}
        {% for product in col.products limit: 1 %}
          {% assign has_products = true %}
        {% endfor %}
        {% if has_products %}
          <div class="shop__category-section" id="category-{{ col.handle }}">
            <h2 class="shop__cat-title">{{ col.title }}</h2>
            <div class="prod-grid">
              {% for product in col.products %}
                <a class="prod-card" href="{{ product.url }}">
                  {% if product.featured_image %}
                    <div class="prod-card__image-wrapper">
                      {% render 'image', class: 'prod-card__image', image: product.featured_image, width: 600, height: 600, crop: 'center' %}
                    </div>
                  {% endif %}
                  <div class="prod-card__info">
                    <div class="prod-card__name">{{ product.title }}</div>
                    <div class="prod-card__price">{{ product.price | money }}</div>
                  </div>
                </a>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      {% endif %}
    {% endfor %}
  </div>
</section>


{% stylesheet %}
  .shop { 
    width: 100%; 
    max-width: 100%;
    box-sizing: border-box;
    position: relative;
    overflow: visible;
  }
  
  .shop__header {
    position: fixed;
    top: 5rem;
    left: 0;
    z-index: 10;
    width: 100%;
    box-sizing: border-box;
    background: #fff;
    border-bottom: 1px solid rgba(0,0,0,.08);
    box-shadow: 0 2px 8px rgba(0,0,0,.04);
  }
  
  .shop__header-inner {
    width: 100%;
    max-width: var(--content-width, calc(var(--page-width, 1280px) - var(--page-margin, 24px) * 2));
    margin: 0 auto;
    padding: 20px 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 32px;
    box-sizing: border-box;
  }
  
  .shop__header-spacer {
    height: 80px; /* Approximate header height, will be calculated by JS */
  }
  
  .shop__header:not([style*="display: none"]) ~ .shop__header-spacer {
    display: block;
  }
  
  .shop__header[style*="display: none"] ~ .shop__header-spacer {
    display: none;
  }
  
  .shop__title { 
    margin: 0; 
    padding: 0;
    flex-shrink: 0;
    font-family: var(--font-primary--family);
    font-size: 20px;
  }
  
  .shop__category-filters {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }
  
  .shop__category-filter {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 18px;
    border: 1px solid rgba(0,0,0,.12);
    border-radius: 8px;
    background: #fff;
    color: #000;
    font-family: 'Poppins', var(--font-primary--family);
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: .02em;
    cursor: pointer;
    transition: all .2s ease;
    white-space: nowrap;
  }
  
  .shop__category-filter:hover {
    border-color: rgba(0,0,0,.25);
    background: rgba(0,0,0,.02);
  }
  
  .shop__category-filter.is-active {
    background: #e3f2fd;
    border-color: #90caf9;
    color: #1976d2;
  }
  
  .shop__category-icon {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    display: block;
    object-fit: contain;
  }
  
  .shop__category-text--mobile {
    display: none;
  }
  
  .shop__content {
    width: 100%;
    max-width: var(--content-width, calc(var(--page-width, 1280px) - var(--page-margin, 24px) * 2));
    margin: 0 auto;
    padding: 0;
    box-sizing: border-box;
    overflow: visible;
  }
  
  /* Ensure shopify-section doesn't clip overflow for shop */
  .shopify-section:has(.shop) {
    overflow: visible;
  }
  
  /* Ensure grid items don't clip */
  .shopify-section:has(.shop) > * {
    overflow: visible;
  }
  
  /* Ensure shop section aligns with shopify-section grid column */
  .shopify-section > .shop {
    width: 100%;
    max-width: 100%;
  }
  
  .shop__header ~ .shop__header-spacer ~ .shop__content {
    padding-top: 100px;
  }
  
  .shop__category-section {
    scroll-margin-top: calc(5rem + 80px + 15px);
    margin-bottom: 80px;
    overflow: visible;
  }
  
  .shop__category-section:last-child {
    margin-bottom: 0;
  }
  
  .shop__cat-title { 
    margin: 0 0 24px; 
    font-size: 30px; 
    font-weight: 700;
    font-family: 'Exo 2', var(--font-primary--family);
  }
  
  .shop .prod-grid { 
    display: grid; 
    grid-template-columns: 1fr; 
    gap: 24px 24px; 
    overflow: visible;

  }
  
  .shop .prod-grid .prod-card:nth-child(n+2) {
    margin-top: 24px;
  }
  
  @media (min-width: 640px) { 
    .shop .prod-grid { 
      grid-template-columns: repeat(2, 1fr); 
      gap: 0 24px;
    }
    /* For 2-column grid, add margin-top starting from 3rd item (2nd row) */
    .shop .prod-grid .prod-card:nth-child(1),
    .shop .prod-grid .prod-card:nth-child(2) {
      margin-top: 0;
    }
    .shop .prod-grid .prod-card:nth-child(n+3) {
      margin-top: 32px;
    }
  }
  
  @media (min-width: 1024px) { 
    .shop .prod-grid { 
      grid-template-columns: repeat(3, 1fr); 
      gap: 0 24px;
    }
    /* For 3-column grid, add margin-top starting from 4th item (2nd row) */
    .shop .prod-grid .prod-card:nth-child(1),
    .shop .prod-grid .prod-card:nth-child(2),
    .shop .prod-grid .prod-card:nth-child(3) {
      margin-top: 0;
    }
    .shop .prod-grid .prod-card:nth-child(n+4) {
      margin-top: 32px;
    }
  }
  
  @media (max-width: 1023px) {
    .shop__header-inner {
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px var(--page-margin);
    }
    
    .shop__title {
      display: none;
    }
    
    .shop__category-filters {
      width: 100%;
      justify-content: center;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding-bottom: 2px;
      flex-wrap: nowrap;
      gap: 8px;
    }
    
    .shop__category-filters::-webkit-scrollbar {
      display: none;
    }
    
    .shop__category-filter {
      flex-shrink: 0;
      padding: 8px 10px;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      border-radius: 8px;
      min-width: 60px;
    }
    
    .shop__category-icon {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
      display: block;
      object-fit: contain;
    }
    
    .shop__category-text {
      display: none;
    }
    
    .shop__category-text--mobile {
      display: block;
      font-size: 10px;
      text-align: center;
      line-height: 1.2;
      white-space: nowrap;
    }
    
    .shop__header-spacer {
      height: 60px;
    }
    
    .shop__cat-title { 
      margin: 0 0 20px; 
      font-size: 24px; 
    }
    
    .shop__header ~ .shop__header-spacer ~ .shop__content {
      padding-top: 80px;
    }
    
    .shop__category-section {
      scroll-margin-top: calc(5rem + 60px + 15px);
      margin-bottom: 60px;
    }
    
    .shop__content {
      padding: 0 16px;
    }
    
    .shop .prod-card__image-wrapper {
      max-width: min(400px, calc(100vw - 48px));
    }
  }
  
  .shop .prod-card { 
    display: flex; 
    flex-direction: column; 
    text-decoration: none; 
    color: inherit; 
    border: none;
    border-radius: 0; 
    background: transparent;
    transition: transform .2s ease;
  }
  
  .shop .prod-card:hover {
    transform: translateY(-2px);
  }
  
  .shop .prod-card:hover .prod-card__name {
    text-decoration: underline;
  }
  
  .shop .prod-card__image-wrapper {
    width: 100%;
    max-width: 400px;
    max-height: 400px;
    aspect-ratio: 1;
    overflow: hidden;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid rgba(0,0,0,.12);
    border-radius: 3px;
  }
  
  .shop .prod-card__image { 
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  
  .shop .prod-card__info {
    padding: 12px 0 0 0;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  
  .shop .prod-card__name { 
    font-weight: 500;
    font-family: var(--font-secondary--family);
    font-size: 14px;
    line-height: 1.4;
    color: #000;
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }
  
  .shop .prod-card__price {
    font-weight: 400;
    font-family: var(--font-secondary--family);
    font-size: 30px;
    color: #000;
  }
{% endstylesheet %}

<script>
  (function(){
    var header = document.querySelector('.shop__header');
    var spacer = document.querySelector('.shop__header-spacer');
    
    // Calculate and set header spacer height dynamically
    var updateHeaderSpacer = function(){
      if (header && spacer && header.offsetParent !== null) {
        spacer.style.height = header.offsetHeight + 'px';
        spacer.style.display = 'block';
      } else if (spacer) {
        spacer.style.display = 'none';
      }
    };
    
    // Initial calculation
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', updateHeaderSpacer);
    } else {
      updateHeaderSpacer();
    }
    
    // Update on resize
    var resizeTimeout = null;
    window.addEventListener('resize', function(){
      if (resizeTimeout) clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(updateHeaderSpacer, 100);
    });
    
    // Handle jump-to button clicks
    document.addEventListener('click', function(e){
      var btn = e.target.closest('.shop__category-filter');
      if (!btn) return;
      
      e.preventDefault();
      var targetHandle = btn.getAttribute('data-target');
      if (!targetHandle) return;
      
      // Find the target section
      var targetSection = document.getElementById('category-' + targetHandle);
      if (!targetSection) return;
      
      // Update active state
      document.querySelectorAll('.shop__category-filter').forEach(function(b){
        b.classList.remove('is-active');
      });
      btn.classList.add('is-active');
      
      // Get header height dynamically
      var headerHeight = header && header.offsetParent !== null ? header.offsetHeight : 0;
      // Responsive offset: main header (5rem) + shop header + title height + extra spacing
      var isMobile = window.innerWidth <= 1023;
      var titleHeight = isMobile ? 40 : 50; // Approximate title height (mobile: 24px font + margin, desktop: 30px font + margin)
      var extraSpacing = isMobile ? 55 : 60; // Extra spacing for visual clearance
      var headerOffset = 5 * 16 + headerHeight + titleHeight + extraSpacing;
      var targetPosition = targetSection.getBoundingClientRect().top + window.pageYOffset - headerOffset;
      
      window.scrollTo({
        top: Math.max(targetPosition, 0),
        behavior: 'smooth'
      });
    });
    
    // Update active button based on scroll position
    var updateActiveButton = function(){
      var sections = document.querySelectorAll('.shop__category-section');
      var buttons = document.querySelectorAll('.shop__category-filter');
      if (sections.length === 0 || buttons.length === 0) return;
      
      var headerHeight = header && header.offsetParent !== null ? header.offsetHeight : 0;
      var headerOffset = 5 * 16 + headerHeight + 15;
      var scrollY = window.pageYOffset || window.scrollY;
      var viewportMiddle = scrollY + window.innerHeight / 2;
      
      var activeSection = null;
      var minDistance = Infinity;
      
      sections.forEach(function(section){
        var rect = section.getBoundingClientRect();
        var sectionTop = rect.top + scrollY;
        var sectionMiddle = sectionTop + rect.height / 2;
        var distance = Math.abs(viewportMiddle - sectionMiddle);
        
        if (distance < minDistance && sectionTop <= scrollY + headerOffset + 100) {
          minDistance = distance;
          activeSection = section;
        }
      });
      
      if (activeSection) {
        var handle = activeSection.id.replace('category-', '');
        buttons.forEach(function(btn){
          if (btn.getAttribute('data-target') === handle) {
            btn.classList.add('is-active');
          } else {
            btn.classList.remove('is-active');
          }
        });
      }
    };
    
    // Throttle scroll events
    var rafId = null;
    var handleScroll = function(){
      if (rafId === null) {
        rafId = requestAnimationFrame(function(){
          updateActiveButton();
          rafId = null;
        });
      }
    };
    
    window.addEventListener('scroll', handleScroll, { passive: true });
    
    // Initial update
    setTimeout(updateActiveButton, 100);
  })();
</script>

{% schema %}
{
  "name": "Shop",
  "settings": [],
  "blocks": [
    {
      "type": "category",
      "name": "Category",
      "settings": [
        { "type": "collection", "id": "collection", "label": "Collection" },
        { "type": "image_picker", "id": "category_icon", "label": "Category Icon", "info": "Upload a custom icon for this category. If not provided, the default flame icon will be used." }
      ]
    },
    {
      "type": "tag",
      "name": "Tag",
      "settings": [
        { "type": "text", "id": "tag", "label": "Tag (exact)" }
      ]
    }
  ],
  "presets": [
    { "name": "Shop" }
  ]
}
{% endschema %}

