<section class="home-community full-width" aria-label="Community">
  <div class="home-community__inner">
    <h2 class="home-community__title">COMMUNITY DRIVEN</h2>
    
    <div class="home-community__viewport">
      <!-- Fade overlays -->
      <div class="home-community__fade home-community__fade--top"></div>
      <div class="home-community__fade home-community__fade--bottom"></div>
      
      <!-- Scrolling masonry container -->
      <div class="home-community__scroll-container">
        <div class="home-community__masonry">
          {%- comment -%} Column 1 - 10 images {%- endcomment -%}
          <div class="home-community__column home-community__column--1">
            <div class="home-community__item home-community__item--tall">
              <img src="{{ 'img_community1.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--square">
              <img src="{{ 'img_community2.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--tall">
              <img src="{{ 'img_community3.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--medium">
              <img src="{{ 'img_community4.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--tall">
              <img src="{{ 'img_community5.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--square">
              <img src="{{ 'img_community6.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--tall">
              <img src="{{ 'img_community7.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--medium">
              <img src="{{ 'img_community8.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--tall">
              <img src="{{ 'img_community9.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--square">
              <img src="{{ 'img_community10.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
          </div>
          
          {%- comment -%} Column 2 - 10 images {%- endcomment -%}
          <div class="home-community__column home-community__column--2">
            <div class="home-community__item home-community__item--medium">
              <img src="{{ 'img_community11.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--tall">
              <img src="{{ 'img_community12.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--square">
              <img src="{{ 'img_community13.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--tall">
              <img src="{{ 'img_community14.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--medium">
              <img src="{{ 'img_community15.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--tall">
              <img src="{{ 'img_community16.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--square">
              <img src="{{ 'img_community17.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--tall">
              <img src="{{ 'img_community18.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--medium">
              <img src="{{ 'img_community19.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--tall">
              <img src="{{ 'img_community20.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
          </div>
          
          {%- comment -%} Column 3 - 10 images {%- endcomment -%}
          <div class="home-community__column home-community__column--3">
            <div class="home-community__item home-community__item--tall">
              <img src="{{ 'img_community21.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--medium">
              <img src="{{ 'img_community22.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--tall">
              <img src="{{ 'img_community23.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--square">
              <img src="{{ 'img_community24.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--tall">
              <img src="{{ 'img_community25.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--medium">
              <img src="{{ 'img_community26.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--tall">
              <img src="{{ 'img_community27.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--square">
              <img src="{{ 'img_community28.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--tall">
              <img src="{{ 'img_community29.PNG' | asset_url }}" alt="Community" loading="lazy">
            </div>
            <div class="home-community__item home-community__item--medium">
              <img src="{{ 'img_community30.png' | asset_url }}" alt="Community" loading="lazy">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

{% stylesheet %}
  .home-community {
    position: relative;
    width: 100vw;
    margin-left: calc(-50vw + 50%);
    height: 100vh;
    height: 100dvh;
    background: #fff;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
  }
  
  .home-community__inner {
    display: flex;
    flex-direction: column;
    height: 100%;
    width: 100%;
    box-sizing: border-box;
  }
  
  .home-community__title {
    font-family: 'Gobold', 'Arial Black', sans-serif;
    font-size: clamp(1.25rem, 2.5vw, 1.75rem);
    font-weight: 700;
    letter-spacing: 0.15em;
    color: #111;
    margin: 0;
    text-align: center;
    padding: 1rem clamp(2rem, 5vw, 4rem);
    flex-shrink: 0;
  }
  
  .home-community__viewport {
    position: relative;
    flex: 1;
    overflow: hidden;
    width: 100%;
  }
  
  /* Fade overlays */
  .home-community__fade {
    position: absolute;
    left: 0;
    right: 0;
    pointer-events: none;
    z-index: 10;
  }
  
  .home-community__fade--top {
    top: 0;
    height: 15%;
    background: linear-gradient(to bottom, 
      rgba(255, 255, 255, 0.9) 0%,
      rgba(255, 255, 255, 0.5) 40%,
      rgba(255, 255, 255, 0) 100%
    );
  }
  
  .home-community__fade--bottom {
    bottom: 0;
    height: 25%;
    background: linear-gradient(to top, 
      rgba(255, 255, 255, 1) 0%,
      rgba(255, 255, 255, 0.8) 30%,
      rgba(255, 255, 255, 0) 100%
    );
  }
  
  .home-community__scroll-container {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    will-change: transform;
  }
  
  .home-community__masonry {
    display: flex;
    justify-content: center;
    gap: clamp(0.75rem, 1.5vw, 1.25rem);
    padding: 0 clamp(2rem, 5vw, 4rem);
  }
  
  .home-community__column {
    display: flex;
    flex-direction: column;
    gap: clamp(0.75rem, 1.5vw, 1.25rem);
    width: clamp(150px, 22vw, 320px);
  }
  
  /* Stagger column starting positions */
  .home-community__column--1 {
    margin-top: 2rem;
  }
  
  .home-community__column--2 {
    margin-top: 0;
  }
  
  .home-community__column--3 {
    margin-top: 3.5rem;
  }
  
  .home-community__item {
    width: 100%;
    border-radius: 8px;
    overflow: hidden;
    background: #f0f0f0;
  }
  
  .home-community__item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  
  /* Size variations */
  .home-community__item--tall {
    aspect-ratio: 3 / 4;
  }
  
  .home-community__item--medium {
    aspect-ratio: 4 / 5;
  }
  
  .home-community__item--square {
    aspect-ratio: 1 / 1;
  }
  
  .home-community__item--wide {
    aspect-ratio: 4 / 3;
  }
  
  /* Placeholder styling */
  .home-community__item--placeholder {
    background: linear-gradient(135deg, #e8e8e8 0%, #f5f5f5 100%);
  }
  
  .home-community__placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  /* Pinned state */
  .home-community.is-pinned {
    top: 0 !important;
  }
  
  /* Mobile adjustments */
  @media (max-width: 768px) {
    .home-community__title {
      font-size: 1rem;
      padding: 1.5rem 1.5rem 1rem;
    }
    
    .home-community__column {
      width: clamp(100px, 28vw, 180px);
    }
    
    .home-community__masonry {
      padding: 0 1rem;
      gap: 0.5rem;
    }
    
    .home-community__column {
      gap: 0.5rem;
    }
    
    .home-community__fade {
      height: 20%;
    }
  }
  
  /* Extra small screens */
  @media (max-width: 480px) {
    .home-community__title {
      font-size: 0.9rem;
      padding: 1.25rem 1rem 0.75rem;
    }
    
    .home-community__column {
      width: 30vw;
    }
    
    .home-community__item {
      border-radius: 6px;
    }
  }
{% endstylesheet %}

<!-- GSAP & ScrollTrigger -->
<script>
(function() {
  function initCommunityScroll() {
    // Wait for GSAP (loaded by bestsellers section)
    if (typeof gsap === 'undefined' || typeof ScrollTrigger === 'undefined') {
      setTimeout(initCommunityScroll, 100);
      return;
    }
    
    gsap.registerPlugin(ScrollTrigger);
    
    var section = document.querySelector('section.home-community');
    if (!section) return;
    
    var scrollContainer = section.querySelector('.home-community__scroll-container');
    var masonry = section.querySelector('.home-community__masonry');
    var viewport = section.querySelector('.home-community__viewport');
    
    if (!scrollContainer || !masonry || !viewport) return;
    
    function getHeaderHeight() {
      var header = document.querySelector('header');
      var headerHeight = header ? header.offsetHeight : 80;
      document.documentElement.style.setProperty('--header-height', headerHeight + 'px');
      return headerHeight;
    }
    
    var headerHeight = getHeaderHeight();
    
    function getContentScrollDistance() {
      var masonryHeight = masonry.scrollHeight;
      var viewportHeight = viewport.offsetHeight;
      return Math.max(0, masonryHeight - viewportHeight);
    }
    
    var scrollTriggerInstance = null;
    var contentScroll = 0;
    
    function createScrollTrigger() {
      if (scrollTriggerInstance) {
        scrollTriggerInstance.kill();
        scrollTriggerInstance = null;
      }
      
      contentScroll = getContentScrollDistance();
      // Use full content scroll for pin duration (slower, more content visible)
      var scrollDuration = contentScroll * 0.85;
      
      scrollTriggerInstance = ScrollTrigger.create({
        trigger: section,
        start: 'top top',
        end: '+=' + scrollDuration,
        pin: true,
        pinSpacing: true,
        scrub: 0.5,
        anticipatePin: 1,
        invalidateOnRefresh: true,
        onUpdate: function(self) {
          var yOffset = -contentScroll * self.progress;
          gsap.set(scrollContainer, { y: yOffset });
        },
        onEnter: function() {
          section.classList.add('is-pinned');
        },
        onLeave: function() {
          section.classList.remove('is-pinned');
        },
        onEnterBack: function() {
          section.classList.add('is-pinned');
        },
        onLeaveBack: function() {
          section.classList.remove('is-pinned');
        }
      });
      
      window.__communityScrollTrigger = scrollTriggerInstance;
    }
    
    // Initialize after images start loading
    var images = masonry.querySelectorAll('img');
    var loadedCount = 0;
    var totalImages = images.length;
    var initialized = false;
    
    function tryInit() {
      if (initialized) return;
      initialized = true;
      createScrollTrigger();
    }
    
    function onImageLoad() {
      loadedCount++;
      if (loadedCount >= Math.min(6, totalImages)) {
        tryInit();
      }
    }
    
    if (totalImages === 0) {
      tryInit();
    } else {
      images.forEach(function(img) {
        if (img.complete) {
          onImageLoad();
        } else {
          img.addEventListener('load', onImageLoad);
          img.addEventListener('error', onImageLoad);
        }
      });
      // Fallback init
      setTimeout(tryInit, 400);
    }
    
    // Handle resize
    var resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(function() {
        getHeaderHeight();
        createScrollTrigger();
        ScrollTrigger.refresh();
      }, 250);
    });
    
    // Final refresh on full load
    window.addEventListener('load', function() {
      setTimeout(function() {
        ScrollTrigger.refresh();
      }, 600);
    });
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCommunityScroll);
  } else {
    initCommunityScroll();
  }
})();
</script>

{% schema %}
{
  "name": "Home Community",
  "settings": [
    {
      "type": "paragraph",
      "content": "Images are loaded from assets folder (img_community1.PNG through img_community30.png)"
    }
  ],
  "presets": [
    {
      "name": "Home Community"
    }
  ]
}
{% endschema %}
