<section class="home-testimonials full-width" aria-label="Testimonials">
  <div class="home-testimonials__inner">
    <div class="home-testimonials__header">
      <h2 class="home-testimonials__title">
        {% if section.settings.heading != blank %}
          {{ section.settings.heading }}
        {% else %}
          TESTIMONIALS
        {% endif %}
      </h2>
    </div>

    <div class="home-testimonials__container">
      {% assign bg_colors = 'hsla(200,55%,91%,1)|hsla(340,48%,91%,1)|hsla(45,58%,91%,1)|hsla(160,50%,91%,1)|hsla(270,42%,91%,1)|hsla(20,58%,91%,1)|hsla(280,45%,90%,1)|hsla(100,48%,90%,1)' | split: '|' %}

      {% for block in section.blocks %}
        {% if block.type == 'testimonial' %}
          {% assign color_index = forloop.index0 | modulo: 8 %}
          {% assign bg_color = bg_colors[color_index] %}
          {% assign is_even = forloop.index0 | modulo: 2 %}

          <div class="home-testimonials__item"
               {{ block.shopify_attributes }}
               data-index="{{ forloop.index0 }}"
               style="--card-bg: {{ bg_color }};"
               data-direction="{% if is_even == 0 %}left{% else %}right{% endif %}">
            <div class="home-testimonials__card-wrapper">
              <div class="home-testimonials__card">
                <div class="home-testimonials__stars" aria-label="Rating: {{ block.settings.stars }} out of 5 stars">
                  {% assign max_stars = 5 %}
                  {% for i in (1..max_stars) %}
                    <span class="home-testimonials__star{% if i <= block.settings.stars %} is-filled{% endif %}"
                          aria-hidden="true"
                          style="--star-index: {{ forloop.index0 }};">★</span>
                  {% endfor %}
                </div>

                <blockquote class="home-testimonials__quote">
                  {% if block.settings.quote != blank %}
                    {{ block.settings.quote }}
                  {% else %}
                    This product exceeded my expectations! The quality and service are outstanding.
                  {% endif %}
                </blockquote>

                {% if block.settings.name != blank %}
                  <cite class="home-testimonials__author">{{ block.settings.name }}</cite>
                {% else %}
                  <cite class="home-testimonials__author">Happy Customer</cite>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}

      {%- comment -%} Fallback placeholders if no testimonials {%- endcomment -%}
      {% if section.blocks.size == 0 %}
        {% for i in (1..5) %}
          {% assign color_index = forloop.index0 | modulo: 8 %}
          {% assign bg_color = bg_colors[color_index] %}
          {% assign is_even = forloop.index0 | modulo: 2 %}

          <div class="home-testimonials__item home-testimonials__item--placeholder"
               data-index="{{ forloop.index0 }}"
               style="--card-bg: {{ bg_color }};"
               data-direction="{% if is_even == 0 %}left{% else %}right{% endif %}">
            <div class="home-testimonials__card-wrapper">
              <div class="home-testimonials__card">
                <div class="home-testimonials__stars" aria-hidden="true">
                  {% for j in (1..5) %}
                    <span class="home-testimonials__star is-filled" style="--star-index: {{ forloop.index0 }};">★</span>
                  {% endfor %}
                </div>
                <blockquote class="home-testimonials__quote">
                  Add testimonial blocks in the theme editor to showcase customer reviews.
                </blockquote>
                <cite class="home-testimonials__author">Customer {{ i }}</cite>
              </div>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>
  </div>
</section>

{% stylesheet %}
  .home-testimonials {
    position: relative;
    width: 100vw;
    margin-left: calc(-50vw + 50%);
    padding: clamp(4rem, 8vh, 6rem) clamp(1.5rem, 4vw, 3rem) clamp(5rem, 10vh, 8rem);
    background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 30%, #f8f9fa 70%, #ffffff 100%);
    overflow: hidden;
  }

  .home-testimonials__inner {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
  }

  .home-testimonials__header {
    text-align: center;
    margin-bottom: clamp(4rem, 8vh, 6rem);
  }

  .home-testimonials__title {
    font-family: 'Gobold', 'Arial Black', sans-serif;
    font-size: clamp(1.5rem, 3vw, 2.25rem);
    font-weight: 700;
    letter-spacing: 0.15em;
    color: #111;
    margin: 0;
  }

  .home-testimonials__container {
    display: flex;
    flex-direction: column;
    gap: clamp(8rem, 15vh, 12rem);
    padding: clamp(3rem, 6vh, 5rem) 0;
    perspective: 1500px;
  }

  .home-testimonials__item {
    width: 100%;
    max-width: clamp(550px, 65vw, 800px);
    margin: 0 auto;
    will-change: transform, opacity;
  }

  /* Alternating alignment */
  .home-testimonials__item[data-direction="left"] {
    align-self: flex-start;
    margin-left: clamp(2rem, 8vw, 8rem);
  }

  .home-testimonials__item[data-direction="right"] {
    align-self: flex-end;
    margin-right: clamp(2rem, 8vw, 8rem);
  }

  /* Card wrapper for 3D transforms */
  .home-testimonials__card-wrapper {
    transform-style: preserve-3d;
    transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .home-testimonials__card {
    position: relative;
    background: var(--card-bg, hsla(200, 55%, 91%, 1));
    border-radius: clamp(28px, 3.5vw, 40px);
    padding: clamp(3rem, 5vw, 4.5rem) clamp(3rem, 5vw, 5rem);
    box-shadow:
      0 4px 16px rgba(0, 0, 0, 0.08),
      0 12px 32px rgba(0, 0, 0, 0.12);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    box-sizing: border-box;
    transform-style: preserve-3d;
    transition:
      box-shadow 0.6s ease,
      background 0.6s ease;
  }

  /* Active state - card in viewport center */
  .home-testimonials__item.is-active .home-testimonials__card {
    box-shadow:
      0 12px 40px rgba(0, 0, 0, 0.15),
      0 24px 80px rgba(0, 0, 0, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.5);
  }

  .home-testimonials__item--placeholder {
    pointer-events: none;
  }

  .home-testimonials__stars {
    display: inline-flex;
    gap: clamp(7px, 0.9vw, 12px);
    margin-bottom: clamp(1.75rem, 3vw, 2.5rem);
    font-size: clamp(1.5rem, 2.2vw, 1.85rem);
  }

  .home-testimonials__star {
    color: rgba(0, 0, 0, 0.12);
    transition: transform 0.3s ease, color 0.3s ease;
    display: inline-block;
  }

  .home-testimonials__star.is-filled {
    color: #ffc107;
    filter: drop-shadow(0 2px 4px rgba(255, 193, 7, 0.3));
  }

  /* Enhanced star animations when card becomes active */
  .home-testimonials__item.is-active .home-testimonials__star.is-filled {
    animation: starPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    animation-delay: calc(var(--star-index) * 0.08s);
  }

  @keyframes starPop {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.2);
    }
    100% {
      transform: scale(1);
    }
  }

  .home-testimonials__quote {
    font-family: var(--font-primary--family, system-ui, sans-serif);
    font-size: clamp(1.1rem, 1.6vw, 1.35rem);
    font-weight: 400;
    line-height: 1.7;
    color: #222;
    margin: 0 0 clamp(1.75rem, 3vw, 2.5rem);
    max-width: 100%;
  }

  .home-testimonials__quote::before {
    content: '"';
  }

  .home-testimonials__quote::after {
    content: '"';
  }

  .home-testimonials__author {
    font-family: 'Gobold', 'Arial Black', sans-serif;
    font-size: clamp(1rem, 1.3vw, 1.15rem);
    font-weight: 700;
    font-style: normal;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: #111;
    margin: 0;
  }

  .home-testimonials__author::before {
    content: '— ';
  }

  /* Tablet adjustments */
  @media (max-width: 1024px) {
    .home-testimonials__item {
      max-width: 80vw;
    }

    .home-testimonials__item[data-direction="left"] {
      margin-left: clamp(1.5rem, 5vw, 5rem);
    }

    .home-testimonials__item[data-direction="right"] {
      margin-right: clamp(1.5rem, 5vw, 5rem);
    }

    .home-testimonials__container {
      gap: 10rem;
    }
  }

  /* Mobile adjustments */
  @media (max-width: 768px) {
    .home-testimonials {
      padding: 3.5rem 1.5rem 4.5rem;
    }

    .home-testimonials__header {
      margin-bottom: 3.5rem;
    }

    .home-testimonials__title {
      font-size: 1.25rem;
    }

    .home-testimonials__container {
      gap: 8rem;
      padding: 2rem 0;
    }

    .home-testimonials__item {
      max-width: 100%;
    }

    /* Center all items on mobile */
    .home-testimonials__item[data-direction="left"],
    .home-testimonials__item[data-direction="right"] {
      align-self: center;
      margin-left: 0;
      margin-right: 0;
    }

    .home-testimonials__card {
      padding: 2.5rem 2.25rem;
      border-radius: 28px;
    }

    .home-testimonials__stars {
      font-size: 1.4rem;
      gap: 7px;
      margin-bottom: 1.5rem;
    }

    .home-testimonials__quote {
      font-size: 1.05rem;
      margin-bottom: 1.5rem;
    }

    .home-testimonials__author {
      font-size: 0.95rem;
    }
  }

  /* Extra small screens */
  @media (max-width: 480px) {
    .home-testimonials {
      padding: 3rem 1rem 4rem;
    }

    .home-testimonials__header {
      margin-bottom: 3rem;
    }

    .home-testimonials__title {
      font-size: 1.1rem;
    }

    .home-testimonials__container {
      gap: 6rem;
    }

    .home-testimonials__card {
      padding: 2.25rem 2rem;
      border-radius: 24px;
    }

    .home-testimonials__stars {
      font-size: 1.3rem;
      gap: 6px;
    }

    .home-testimonials__quote {
      font-size: 1rem;
    }

    .home-testimonials__author {
      font-size: 0.9rem;
    }
  }
{% endstylesheet %}

<!-- GSAP & ScrollTrigger -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js" defer></script>

<script>
(function() {
  function initTestimonials() {
    if (typeof gsap === 'undefined' || typeof ScrollTrigger === 'undefined') {
      setTimeout(initTestimonials, 50);
      return;
    }

    gsap.registerPlugin(ScrollTrigger);

    var section = document.querySelector('section.home-testimonials');
    if (!section) return;

    var items = Array.prototype.slice.call(section.querySelectorAll('.home-testimonials__item'));
    if (items.length === 0) return;

    var isMobile = window.innerWidth <= 768;

    // Track animation state for each item
    var itemStates = items.map(function() { return { animated: false }; });

    // Set initial hidden state for all items
    items.forEach(function(item, index) {
      var direction = item.getAttribute('data-direction');
      var startX = direction === 'left' ? -200 : 200;
      gsap.set(item, { x: startX, opacity: 0 });
    });

    // Observer for animate IN - triggers when item enters viewport (with margin buffer)
    var observerInOptions = {
      root: null,
      rootMargin: isMobile ? '-10% 0px -10% 0px' : '-15% 0px -15% 0px',
      threshold: 0.1
    };

    var observerIn = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        var item = entry.target;
        var index = items.indexOf(item);
        if (index === -1) return;

        if (entry.isIntersecting && !itemStates[index].animated) {
          var direction = item.getAttribute('data-direction');
          console.log('Item', index, 'animating IN');
          itemStates[index].animated = true;
          gsap.to(item, {
            x: 0,
            opacity: 1,
            duration: 1,
            ease: 'power2.out'
          });
        }
      });
    }, observerInOptions);

    // Observer for animate OUT - triggers when item exits at 50% viewport (scrolling back up)
    var observerOutOptions = {
      root: null,
      rootMargin: '0px 0px -50% 0px', // Bottom boundary at 50% of viewport
      threshold: 0
    };

    var observerOut = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        var item = entry.target;
        var index = items.indexOf(item);
        if (index === -1) return;

        var rect = item.getBoundingClientRect();
        var direction = item.getAttribute('data-direction');
        var startX = direction === 'left' ? -200 : 200;

        // When not intersecting (item below 50% line) and was animated, animate out
        if (!entry.isIntersecting && itemStates[index].animated && rect.top > window.innerHeight * 0.4) {
          console.log('Item', index, 'animating OUT at rect.top:', Math.round(rect.top));
          itemStates[index].animated = false;
          gsap.to(item, {
            x: startX,
            opacity: 0,
            duration: 0.6,
            ease: 'power2.in'
          });
        }
      });
    }, observerOutOptions);

    // Observe all items with both observers
    items.forEach(function(item) {
      observerIn.observe(item);
      observerOut.observe(item);
    });

    // Star animation using ScrollTrigger (less affected by pin issues since it's just a class toggle)
    items.forEach(function(item, index) {
      ScrollTrigger.create({
        trigger: item,
        start: 'top 55%',
        end: 'bottom 45%',
        toggleClass: 'is-active',
        refreshPriority: -1
      });
    });

    // Update on resize
    var resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(function() {
        isMobile = window.innerWidth <= 768;
        // Update observer margins for new viewport
        observerIn.disconnect();
        observerOut.disconnect();
        observerInOptions.rootMargin = isMobile ? '-10% 0px -10% 0px' : '-15% 0px -15% 0px';

        observerIn = new IntersectionObserver(function(entries) {
          entries.forEach(function(entry) {
            var item = entry.target;
            var index = items.indexOf(item);
            if (index === -1) return;

            if (entry.isIntersecting && !itemStates[index].animated) {
              var direction = item.getAttribute('data-direction');
              console.log('Item', index, 'animating IN (after resize)');
              itemStates[index].animated = true;
              gsap.to(item, {
                x: 0,
                opacity: 1,
                duration: 1,
                ease: 'power2.out'
              });
            }
          });
        }, observerInOptions);

        observerOut = new IntersectionObserver(function(entries) {
          entries.forEach(function(entry) {
            var item = entry.target;
            var index = items.indexOf(item);
            if (index === -1) return;

            var rect = item.getBoundingClientRect();
            var direction = item.getAttribute('data-direction');
            var startX = direction === 'left' ? -200 : 200;

            if (!entry.isIntersecting && itemStates[index].animated && rect.top > window.innerHeight * 0.4) {
              console.log('Item', index, 'animating OUT (after resize)');
              itemStates[index].animated = false;
              gsap.to(item, {
                x: startX,
                opacity: 0,
                duration: 0.6,
                ease: 'power2.in'
              });
            }
          });
        }, observerOutOptions);

        items.forEach(function(item) {
          observerIn.observe(item);
          observerOut.observe(item);
        });
        ScrollTrigger.refresh();
      }, 250);
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTestimonials);
  } else {
    initTestimonials();
  }
})();
</script>

{% schema %}
{
  "name": "Home testimonials",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "TESTIMONIALS"
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        {
          "type": "range",
          "id": "stars",
          "label": "Star rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "default": 5
        },
        {
          "type": "textarea",
          "id": "quote",
          "label": "Quote",
          "default": "This product exceeded my expectations! The quality and service are outstanding."
        },
        {
          "type": "text",
          "id": "name",
          "label": "Customer name",
          "default": "John Smith"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Home testimonials",
      "blocks": [
        {
          "type": "testimonial"
        },
        {
          "type": "testimonial"
        },
        {
          "type": "testimonial"
        },
        {
          "type": "testimonial"
        },
        {
          "type": "testimonial"
        }
      ]
    }
  ]
}
{% endschema %}
