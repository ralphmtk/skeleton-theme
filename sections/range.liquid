{% comment %}
  Range page
  
  Product Sorting:
  - Products are displayed in the order they appear in the collection (set in Shopify admin)
  - Available products are shown first, followed by unavailable products at the end
{% endcomment %}

{{ 'range.css' | asset_url | stylesheet_tag }}
{{ 'range-style-overrides.css' | asset_url | stylesheet_tag }}

{% assign user_country_code = localization.country.iso_code | downcase %}

{%- comment -%} Count categories with products {%- endcomment -%}
{% assign category_count = 0 %}
{% for block in section.blocks %}
  {% if block.type == 'category' and block.settings.collection != blank %}
    {% assign col = block.settings.collection %}
    {% assign has_products = false %}
    {% for product in col.products limit: 1 %}
      {% assign has_products = true %}
    {% endfor %}
    {% if has_products %}
      {% assign category_count = category_count | plus: 1 %}
    {% endif %}
  {% endif %}
{% endfor %}

{% assign show_header = false %}
{% if category_count > 1 %}
  {% assign show_header = true %}
{% endif %}

<section class="range full-width">
  {% if show_header %}
  <div class="range__header">
    <div class="range__header-inner">
      <h1 class="range__title">RANGE</h1>
      
      {%- comment -%} Category jump-to buttons {%- endcomment -%}
      <div class="range__category-filters">
      {% assign first = true %}
      {% for block in section.blocks %}
        {% if block.type == 'category' and block.settings.collection != blank %}
          {% assign col = block.settings.collection %}
          {% assign has_products = false %}
          {% for product in col.products limit: 1 %}
            {% assign has_products = true %}
          {% endfor %}
          {% if has_products %}
            {% assign mobile_title = col.title %}
            {% if mobile_title == 'Jet Lighters' %}{% assign mobile_title = 'Lighters' %}{% endif %}
            {% if mobile_title == 'Jet Torches' %}{% assign mobile_title = 'Torches' %}{% endif %}
            {% if mobile_title == 'Gas Refills' %}{% assign mobile_title = 'Gas' %}{% endif %}
            <button class="range__category-filter{% if first %} is-active{% endif %}" data-target="{{ col.handle }}" type="button">
              {% if block.settings.category_icon != blank %}
                <img class="range__category-icon" src="{{ block.settings.category_icon | image_url: width: 32 }}" alt="" width="16" height="16" loading="lazy">
              {% else %}
                <img class="range__category-icon" src="{{ 'flame-icon.png' | asset_url }}" alt="" width="16" height="16" loading="lazy">
              {% endif %}
              <span class="range__category-text">{{ col.title }}</span>
              <span class="range__category-text--mobile">{{ mobile_title }}</span>
            </button>
            {% assign first = false %}
          {% endif %}
        {% endif %}
      {% endfor %}
      </div>
    </div>
  </div>
  
  {%- comment -%} Spacer to prevent content from going under fixed header {%- endcomment -%}
  <div class="range__header-spacer"></div>
  {% endif %}

  <div class="range__content">
    {% for block in section.blocks %}
      {% if block.type == 'category' and block.settings.collection != blank %}
        {% assign col = block.settings.collection %}
        {% assign has_products = false %}
        {% for product in col.products limit: 1 %}
          {% assign has_products = true %}
        {% endfor %}
        {% if has_products %}
          <div class="range__category-section" id="category-{{ col.handle }}">
            <h2 class="range__cat-title">{{ col.title }}</h2>
            <div class="prod-grid">
              {%- comment -%} Single pass with capture for sorting {%- endcomment -%}
              {% capture available_output %}
              {% endcapture %}
              {% capture unavailable_output %}
              {% endcapture %}

              {% for product in col.products %}
                {%- comment -%} Check product availability based on metafields {%- endcomment -%}
                {% assign is_unavailable = false %}
                {% assign available_countries = product.metafields.custom.available_countries | downcase | strip %}
                {% assign unavailable_countries = product.metafields.custom.unavailable_countries | downcase | strip %}
                
                {% if available_countries != blank %}
                  {%- comment -%} Product is only available in listed countries {%- endcomment -%}
                  {% assign available_list = available_countries | split: ',' %}
                  {% assign country_found = false %}
                  {% for country in available_list %}
                    {% assign country_trimmed = country | strip %}
                    {% if country_trimmed == user_country_code %}
                      {% assign country_found = true %}
                      {% break %}
                    {% endif %}
                  {% endfor %}
                  {% unless country_found %}
                    {% assign is_unavailable = true %}
                  {% endunless %}
                {% elsif unavailable_countries != blank %}
                  {%- comment -%} Product is unavailable in listed countries {%- endcomment -%}
                  {% assign unavailable_list = unavailable_countries | split: ',' %}
                  {% for country in unavailable_list %}
                    {% assign country_trimmed = country | strip %}
                    {% if country_trimmed == user_country_code %}
                      {% assign is_unavailable = true %}
                      {% break %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
                
                {% if is_unavailable %}
                  {% capture unavailable_output %}
                    {{ unavailable_output }}
                    {% render 'range-product-card', product: product, is_unavailable: true, localization: localization, collection_handle: col.handle %}
                  {% endcapture %}
                {% else %}
                  {% capture available_output %}
                    {{ available_output }}
                    {% render 'range-product-card', product: product, is_unavailable: false, localization: localization, collection_handle: col.handle %}
                  {% endcapture %}
                {% endif %}
              {% endfor %}
              
              {{ available_output }}
              {{ unavailable_output }}
            </div>
          </div>
        {% endif %}
      {% endif %}
    {% endfor %}
  </div>
</section>



<script>
  (function(){
    var header = document.querySelector('.range__header');
    var spacer = document.querySelector('.range__header-spacer');
    
    // Calculate and set header spacer height dynamically
    var updateHeaderSpacer = function(){
      if (header && spacer && header.offsetParent !== null) {
        spacer.style.height = header.offsetHeight + 'px';
        spacer.style.display = 'block';
      } else if (spacer) {
        spacer.style.display = 'none';
      }
    };
    
    // Initial calculation
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', updateHeaderSpacer);
    } else {
      updateHeaderSpacer();
    }
    
    // Update on resize
    var resizeTimeout = null;
    window.addEventListener('resize', function(){
      if (resizeTimeout) clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(updateHeaderSpacer, 100);
    });
    
    // Handle jump-to button clicks
    document.addEventListener('click', function(e){
      var btn = e.target.closest('.range__category-filter');
      if (!btn) return;
      
      e.preventDefault();
      var targetHandle = btn.getAttribute('data-target');
      if (!targetHandle) return;
      
      // Find the target section
      var targetSection = document.getElementById('category-' + targetHandle);
      if (!targetSection) return;
      
      // Update active state
      document.querySelectorAll('.range__category-filter').forEach(function(b){
        b.classList.remove('is-active');
      });
      btn.classList.add('is-active');
      
      // Get header height dynamically
      var headerHeight = header && header.offsetParent !== null ? header.offsetHeight : 0;
      // Responsive offset: main header (5rem) + range header + title height + extra spacing
      var isMobile = window.innerWidth <= 1023;
      var titleHeight = isMobile ? 40 : 50; // Approximate title height (mobile: 24px font + margin, desktop: 30px font + margin)
      var extraSpacing = isMobile ? 55 : 60; // Extra spacing for visual clearance
      var headerOffset = 5 * 16 + headerHeight + titleHeight + extraSpacing;
      var targetPosition = targetSection.getBoundingClientRect().top + window.pageYOffset - headerOffset;
      
      window.scrollTo({
        top: Math.max(targetPosition, 0),
        behavior: 'smooth'
      });
    });
    
    // Update active button based on scroll position
    var updateActiveButton = function(){
      var sections = document.querySelectorAll('.range__category-section');
      var buttons = document.querySelectorAll('.range__category-filter');
      if (sections.length === 0 || buttons.length === 0) return;
      
      var headerHeight = header && header.offsetParent !== null ? header.offsetHeight : 0;
      var headerOffset = 5 * 16 + headerHeight + 15;
      var scrollY = window.pageYOffset || window.scrollY;
      var viewportMiddle = scrollY + window.innerHeight / 2;
      
      var activeSection = null;
      var minDistance = Infinity;
      
      sections.forEach(function(section){
        var rect = section.getBoundingClientRect();
        var sectionTop = rect.top + scrollY;
        var sectionMiddle = sectionTop + rect.height / 2;
        var distance = Math.abs(viewportMiddle - sectionMiddle);
        
        if (distance < minDistance && sectionTop <= scrollY + headerOffset + 100) {
          minDistance = distance;
          activeSection = section;
        }
      });
      
      if (activeSection) {
        var handle = activeSection.id.replace('category-', '');
        buttons.forEach(function(btn){
          if (btn.getAttribute('data-target') === handle) {
            btn.classList.add('is-active');
          } else {
            btn.classList.remove('is-active');
          }
        });
      }
    };
    
    // Throttle scroll events
    var rafId = null;
    var handleScroll = function(){
      if (rafId === null) {
        rafId = requestAnimationFrame(function(){
          updateActiveButton();
          rafId = null;
        });
      }
    };
    
    window.addEventListener('scroll', handleScroll, { passive: true });
    
    // Initial update
    setTimeout(updateActiveButton, 100);
  })();
</script>

{% schema %}
{
  "name": "Range",
  "settings": [],
  "blocks": [
    {
      "type": "category",
      "name": "Category",
      "settings": [
        { "type": "collection", "id": "collection", "label": "Collection" },
        { "type": "image_picker", "id": "category_icon", "label": "Category Icon", "info": "Upload a custom icon for this category. If not provided, the default flame icon will be used." }
      ]
    },
    {
      "type": "tag",
      "name": "Tag",
      "settings": [
        { "type": "text", "id": "tag", "label": "Tag (exact)" }
      ]
    }
  ],
  "presets": [
    { "name": "Range" }
  ]
}
{% endschema %}